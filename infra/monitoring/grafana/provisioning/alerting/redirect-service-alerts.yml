apiVersion: 1

groups:
  - orgId: 1
    name: Redirect Service Reliability
    folder: Shortly
    interval: 1m
    rules:
      # ì•ŒëŒ 1: í´ë¦­ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ìœ¨ ê²½ê³ 
      - uid: click_event_failure_warning
        title: í´ë¦­ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ìœ¨ ê²½ê³  (5% ì´ˆê³¼)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (rate(click_event_published_failure_total[5m]) /
                (rate(click_event_published_success_total[5m]) + rate(click_event_published_failure_total[5m]))) > 0.05
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "í´ë¦­ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ìœ¨ì´ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          description: "í˜„ì¬ ì‹¤íŒ¨ìœ¨: {{ $values.A.Value | printf \"%.2f\" }}%. Kafka ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
          runbook_url: "https://github.com/your-org/shortly/wiki/Runbook-Click-Event-Failure"
        labels:
          severity: warning
          service: redirect-service
          component: kafka-producer

      # ì•ŒëŒ 2: í´ë¦­ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ìœ¨ ì‹¬ê°
      - uid: click_event_failure_critical
        title: í´ë¦­ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ìœ¨ ì‹¬ê° (20% ì´ˆê³¼)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (rate(click_event_published_failure_total[2m]) /
                (rate(click_event_published_success_total[2m]) + rate(click_event_published_failure_total[2m]))) > 0.20
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "âš ï¸ í´ë¦­ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ìœ¨ì´ 20%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          description: "í˜„ì¬ ì‹¤íŒ¨ìœ¨: {{ $values.A.Value | printf \"%.2f\" }}%. Kafka ê¸´ê¸‰ ì ê²€ í•„ìš”!"
          runbook_url: "https://github.com/your-org/shortly/wiki/Runbook-Kafka-Critical-Failure"
        labels:
          severity: critical
          service: redirect-service
          component: kafka-producer

      # ì•ŒëŒ 3: Kafka Circuit Breaker Open
      - uid: kafka_circuit_breaker_open
        title: Kafka Circuit Breaker Open (í´ë¦­ ì´ë²¤íŠ¸ ìœ ì‹¤ ì¤‘)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                increase(click_event_published_circuit_open_total[1m]) > 0
              refId: A
        noDataState: OK
        execErrState: OK
        for: 1m
        annotations:
          summary: "ğŸ”´ Kafka Circuit Breakerê°€ Open ìƒíƒœì…ë‹ˆë‹¤"
          description: "í´ë¦­ ì´ë²¤íŠ¸ê°€ ìœ ì‹¤ë˜ê³  ìˆìŠµë‹ˆë‹¤. Kafka ë¸Œë¡œì»¤ ìƒíƒœë¥¼ ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”."
          runbook_url: "https://github.com/your-org/shortly/wiki/Runbook-Circuit-Breaker-Open"
        labels:
          severity: critical
          service: redirect-service
          component: circuit-breaker

      # ì•ŒëŒ 4: Redis Pub/Sub ì‹¤íŒ¨ìœ¨ ê²½ê³ 
      - uid: redis_pubsub_failure_warning
        title: Redis Pub/Sub ì‹¤íŒ¨ìœ¨ ê²½ê³  (10% ì´ˆê³¼)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (rate(cache_pubsub_published_failure_total[5m]) /
                (rate(cache_pubsub_published_success_total[5m]) + rate(cache_pubsub_published_failure_total[5m]))) > 0.10
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "Redis Pub/Sub ì‹¤íŒ¨ìœ¨ì´ 10%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          description: "L1 ìºì‹œ ë™ê¸°í™” ì§€ì—° ë°œìƒ ì¤‘. í˜„ì¬ ì‹¤íŒ¨ìœ¨: {{ $values.A.Value | printf \"%.2f\" }}%"
          runbook_url: "https://github.com/your-org/shortly/wiki/Runbook-Redis-PubSub-Failure"
        labels:
          severity: warning
          service: redirect-service
          component: redis-pubsub

      # ì•ŒëŒ 5: UrlCreatedEvent Consumer ì˜ˆìƒ ëª»í•œ ì˜¤ë¥˜
      - uid: url_created_event_unexpected_error
        title: UrlCreatedEvent Consumer ì˜ˆìƒ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ (ë²„ê·¸ ê°€ëŠ¥ì„±)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                increase(url_created_event_processed_unexpected_error_total[5m]) > 0
              refId: A
        noDataState: OK
        execErrState: OK
        for: 5m
        annotations:
          summary: "âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ - ë²„ê·¸ ê°€ëŠ¥ì„±"
          description: "shortCode={{ $labels.shortCode }}, exception={{ $labels.exception }}. ì½”ë“œ ë¦¬ë·° ë° ë²„ê·¸ ìˆ˜ì • í•„ìš”."
          runbook_url: "https://github.com/your-org/shortly/wiki/Runbook-Unexpected-Error"
        labels:
          severity: warning
          service: redirect-service
          component: event-consumer
          bug: "true"

      # ì•ŒëŒ 6: UrlCreatedEvent Consumer ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ (ê¸´ê¸‰)
      - uid: url_created_event_unknown_error
        title: UrlCreatedEvent Consumer ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë‹¤ìˆ˜ ë°œìƒ (ê¸´ê¸‰ ì ê²€)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                increase(url_created_event_processed_unknown_error_total[2m]) > 10
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "ğŸ”´ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë‹¤ìˆ˜ ë°œìƒ - ê¸´ê¸‰ ì ê²€ í•„ìš”"
          description: "ìµœê·¼ 2ë¶„ê°„ 10ê±´ ì´ìƒì˜ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ. JVM, ë©”ëª¨ë¦¬, ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ í•„ìš”."
          runbook_url: "https://github.com/your-org/shortly/wiki/Runbook-Unknown-Error-Critical"
        labels:
          severity: critical
          service: redirect-service
          component: event-consumer

      # ì•ŒëŒ 7: UrlCreatedEvent ì²˜ë¦¬ ì‹¤íŒ¨ìœ¨ ê²½ê³ 
      - uid: url_created_event_failure_warning
        title: UrlCreatedEvent ì²˜ë¦¬ ì‹¤íŒ¨ìœ¨ ê²½ê³  (10% ì´ˆê³¼)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (rate(url_created_event_processed_redis_failure_total[5m]) +
                 rate(url_created_event_processed_pubsub_failure_total[5m]) +
                 rate(url_created_event_processed_unexpected_error_total[5m]) +
                 rate(url_created_event_processed_unknown_error_total[5m])) /
                rate(url_created_event_processed_success_total[5m]) > 0.10
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "ìºì‹œ ì›Œë°ì—… ì‹¤íŒ¨ìœ¨ì´ 10%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          description: "Redis ë˜ëŠ” Pub/Sub ì¥ì•  ê°€ëŠ¥ì„±. ì²« ì¡°íšŒ ì‹œ L2 Fallback ì¦ê°€ ì˜ˆìƒ."
          runbook_url: "https://github.com/your-org/shortly/wiki/Runbook-Cache-Warmup-Failure"
        labels:
          severity: warning
          service: redirect-service
          component: cache-warmup
