# Shortly NGINX Configuration
# 단순 라우팅 + 로드 밸런싱

events {
    worker_connections 4096;  # 높은 동시 접속 지원
}

http {
    # 로깅
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # 성능 최적화
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Upstream 정의
    upstream url-service {
        # URL 생성 서비스
        server url-service:8081 max_fails=3 fail_timeout=30s;
    }

    upstream redirect-service {
        # Redirect 서비스 (Read-Heavy, 95% 트래픽)
        # 여러 인스턴스로 로드 밸런싱
        server redirect-service:8082 max_fails=3 fail_timeout=30s;

        # 추가 인스턴스 (docker-compose scale 시 자동 추가)
        # server redirect-service-2:8082 max_fails=3 fail_timeout=30s;
        # server redirect-service-3:8082 max_fails=3 fail_timeout=30s;

        # 로드 밸런싱 방식: 기본 Round Robin
        # least_conn;  # 연결 수 기반 (선택)
        # ip_hash;     # 클라이언트 IP 기반 (선택)
    }

    upstream click-service {
        # Click 통계 서비스
        server click-service:8083 max_fails=3 fail_timeout=30s;
    }

    # Main Server
    server {
        listen 80;
        server_name localhost shortly.local;

        # Health Check Endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Redirect Service (가장 많은 트래픽)
        location /r/ {
            proxy_pass http://redirect-service;

            # 기본 프록시 설정
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 타임아웃 (빠른 응답 기대)
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;

            # 성능 최적화 (Redirect는 응답이 작음)
            proxy_buffering off;
            proxy_request_buffering off;

            # Health Check 연동
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }

        # URL Service (URL 생성/조회)
        location /api/v1/urls {
            proxy_pass http://url-service;

            # 기본 프록시 설정
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 타임아웃
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;

            # Health Check 연동
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }

        # Click Service (클릭 통계)
        location /api/v1/clicks {
            proxy_pass http://click-service;

            # 기본 프록시 설정
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 타임아웃
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;

            # Health Check 연동
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }

        # Prometheus Metrics (모니터링)
        location /metrics {
            # NGINX Stub Status (기본 메트릭)
            stub_status on;
            access_log off;

            # 보안: 내부 네트워크만 허용 (선택)
            # allow 10.0.0.0/8;
            # deny all;
        }

        # Grafana (모니터링 대시보드)
        location /grafana/ {
            proxy_pass http://grafana:3000/;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prometheus (메트릭 수집)
        location /prometheus/ {
            proxy_pass http://prometheus:9090/;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
