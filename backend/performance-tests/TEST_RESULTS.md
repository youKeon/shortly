# Phase 3 í…ŒìŠ¤íŠ¸ ê²°ê³¼ (10K TPS ëª©í‘œ)

## í…ŒìŠ¤íŠ¸ í™˜ê²½
- **ì•„í‚¤í…ì²˜**: Spring Boot (Tomcat) + Redis Cache + Kafka
- **í…ŒìŠ¤íŠ¸ ë„êµ¬**: k6
- **ëª©í‘œ TPS**: 10,000+
- **ìµœëŒ€ VU**: 1,200
- **í…ŒìŠ¤íŠ¸ ì‹œê°„**: 3ë¶„

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼

| ì§€í‘œ | ê²°ê³¼ | ëª©í‘œ | ë‹¬ì„± ì—¬ë¶€ |
|------|------|------|-----------|
| **TPS** | **4,940** | 10,000+ | âŒ **49.4%** |
| **P95 ì‘ë‹µ ì‹œê°„** | **360.56ms** | <200ms | âŒ |
| **í‰ê·  ì‘ë‹µ ì‹œê°„** | **166.87ms** | - | âœ… |
| **ì¤‘ê°„ê°’ ì‘ë‹µ ì‹œê°„** | **154.57ms** | - | âœ… |
| **ì—ëŸ¬ìœ¨** | **0%** | <5% | âœ… |
| **ë¦¬ë””ë ‰ì…˜ ì„±ê³µë¥ ** | **100%** | >95% | âœ… |
| **ë‹¨ì¶• ì„±ê³µë¥ ** | **100%** | >95% | âœ… |
| **ì´ ìš”ì²­ ìˆ˜** | **890,227** | - | - |

---

## ì•„í‚¤í…ì²˜

```
Client Request
    â†“
Tomcat (Thread Pool: max 500)
    â†“
ShortUrlService (Blocking)
    â†“
Redis Cache (L1) â† ëŒ€ë¶€ë¶„ ìš”ì²­ ì²˜ë¦¬
    â†“ (Cache Miss)
MySQL DB (JPA)
    â†“ (í´ë¦­ ì´ë²¤íŠ¸)
Kafka (ë¹„ë™ê¸° ì²˜ë¦¬) â†’ UrlClickEventConsumer â†’ DB ì €ì¥
```

### ì£¼ìš” êµ¬ì„±
- **Web Server**: Tomcat (Thread-based, Blocking I/O)
- **Cache**: Redis (ê¸€ë¡œë²Œ ìºì‹œ)
- **Event Streaming**: Kafka (ë¹„ë™ê¸° í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬)
- **DB Connection Pool**: HikariCP (max: 50)

### Kafka ì´ë²¤íŠ¸ í”Œë¡œìš°
```
Redirect ìš”ì²­ â†’ ShortUrlService â†’ Kafka Producer (ë¹„ë™ê¸°)
                                      â†“
                                  Kafka Topic: url-clicked
                                      â†“
                                  Consumer â†’ DB í´ë¦­ ìˆ˜ ì—…ë°ì´íŠ¸
```

---

## Phase ê°„ ë¹„êµ

| Phase | ì•„í‚¤í…ì²˜ | TPS | P95 | í‰ê·  | ê°œì„ ìœ¨ |
|-------|---------|-----|-----|------|-------|
| **Phase 1** | Tomcat (No Cache) | 4,198 | 430.43ms | 196.15ms | - |
| **Phase 2** | Tomcat + Redis | 4,587 | 425.18ms | 179.5ms | +9.3% |
| **Phase 3** | Tomcat + Redis + Kafka | **4,940** | **360.56ms** | **166.87ms** | **+7.7%** âœ… |

### ğŸ¯ Phase 3ì˜ ê°œì„  íš¨ê³¼

Phase 3ê°€ Phase 2ë³´ë‹¤ ì„±ëŠ¥ì´ í–¥ìƒëœ ì´ìœ :

#### 1. **ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬**
```java
// Phase 2: ë™ê¸° í´ë¦­ ì¹´ìš´íŠ¸
public void incrementClickCount(Long urlId) {
    urlClickRepository.save(...); // Blocking DB ì“°ê¸°
}

// Phase 3: ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë°œí–‰
public void incrementClickCount(Long urlId) {
    kafkaProducer.send(new UrlClickedEvent(urlId)); // ì¦‰ì‹œ ë°˜í™˜
}
```

**íš¨ê³¼:**
- í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ê°€ ì‘ë‹µ ì‹œê°„ì— ì˜í–¥ ì—†ìŒ
- DB ì“°ê¸° ë¶€í•˜ê°€ ë©”ì¸ ìš”ì²­ê³¼ ë¶„ë¦¬
- TPS: 4,587 â†’ 4,940 (+7.7%)

#### 2. **DB ì“°ê¸° ë¶€í•˜ ë¶„ì‚°**
- í´ë¦­ ì´ë²¤íŠ¸ê°€ Kafka Consumerì—ì„œ ë°°ì¹˜ ì²˜ë¦¬
- DB Connection Poolì´ ì½ê¸°ì— ì§‘ì¤‘
- ì“°ê¸° ë¶€í•˜ê°€ ì‹œê°„ìƒ ë¶„ì‚°

#### 3. **ì‘ë‹µ ì‹œê°„ ê°œì„ **
- í‰ê· : 179.5ms â†’ 166.87ms (-7.0%)
- P95: 425.18ms â†’ 360.56ms (-15.2%) âœ…

---

## ì„±ëŠ¥ ë¶„ì„

### âœ… ê°œì„ ëœ ì 

#### 1. **ë¹„ë™ê¸° ì²˜ë¦¬ íš¨ê³¼**
```
Phase 2 ì‘ë‹µ ì‹œê°„: ë¦¬ë””ë ‰ì…˜ + Redis ìºì‹œ + ë™ê¸° DB ì“°ê¸°
Phase 3 ì‘ë‹µ ì‹œê°„: ë¦¬ë””ë ‰ì…˜ + Redis ìºì‹œ (DB ì“°ê¸° ì œì™¸)

â†’ í´ë¦­ ì¹´ìš´íŠ¸ ì²˜ë¦¬ ì‹œê°„ ì ˆì•½ (~10-20ms)
```

#### 2. **ë” ë§ì€ ìš”ì²­ ì²˜ë¦¬**
- ì´ ìš”ì²­: 827,486 (Phase 2) â†’ 890,227 (Phase 3)
- **+7.6% ì¦ê°€**

#### 3. **ì•ˆì •ì ì¸ ì²˜ë¦¬**
- ì—ëŸ¬ìœ¨ 0% ìœ ì§€
- 89ë§Œ ê±´ ìš”ì²­ ë¬´ê²°ì  ì²˜ë¦¬

---

### âŒ ì—¬ì „í•œ í•œê³„

#### 1. **10K TPS ëª©í‘œ ë¯¸ë‹¬** (49.4%)
- Tomcat Blocking ëª¨ë¸ì˜ ê·¼ë³¸ì  í•œê³„
- Redis ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ
- ë¡œì»¬ ìºì‹œ ë¶€ì¬

#### 2. **P95 ì—¬ì „íˆ ë†’ìŒ** (360.56ms)
- ìŠ¤ë ˆë“œ í’€ í¬í™” ì‹œ íì‰
- Redis ë„¤íŠ¸ì›Œí¬ ì§€ì—°

---

## ìƒì„¸ ë©”íŠ¸ë¦­

### HTTP ìš”ì²­
```
ì´ ìš”ì²­ ìˆ˜:        890,227
TPS:              4,940/s
í‰ê·  ì‘ë‹µ ì‹œê°„:    166.87ms
ì¤‘ê°„ê°’:           154.57ms
P90:              304.27ms
P95:              360.56ms
ìµœëŒ€:             1.49s
```

### íŠ¸ë˜í”½ ë¶„í¬
```
ë¦¬ë””ë ‰ì…˜ ìš”ì²­:     800,568 (90%)
ë‹¨ì¶• ìš”ì²­:         89,459 (10%)
```

### ì„±ê³µë¥ 
```
ì „ì²´ ì„±ê³µë¥ :       100%
ë¦¬ë””ë ‰ì…˜ ì„±ê³µë¥ :   100%
ë‹¨ì¶• ì„±ê³µë¥ :       100%
ì—ëŸ¬ìœ¨:           0%
```

---

## Kafkaì˜ ì—­í• 

### ì¥ì 
âœ… **ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•** (ë¹„ë™ê¸° ì²˜ë¦¬)
âœ… **DB ì“°ê¸° ë¶€í•˜ ë¶„ì‚°**
âœ… **í™•ì¥ ê°€ëŠ¥í•œ ì´ë²¤íŠ¸ ì•„í‚¤í…ì²˜**
âœ… **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í†µí•© ì¤€ë¹„**

### í•œê³„
âš ï¸ **TPS í•œê³„ í•´ê²° ëª»í•¨** (ê·¼ë³¸ ì›ì¸: Blocking I/O)
âš ï¸ **ë³µì¡ë„ ì¦ê°€** (Kafka ìš´ì˜ í•„ìš”)

---

## ê°œì„  ë°©ì•ˆ

### 1ï¸âƒ£ **ë¡œì»¬ ìºì‹œ ì¶”ê°€** (Caffeine + Redis)
```java
// L1: Caffeine (ë¡œì»¬ ë©”ëª¨ë¦¬) - ì´ˆê³ ì†
// L2: Redis (ê¸€ë¡œë²Œ ìºì‹œ) - ì¼ê´€ì„±
```
**ì˜ˆìƒ íš¨ê³¼:**
- TPS: 4,940 â†’ **7,000+** (+42%)
- P95: 360ms â†’ **<250ms** (-31%)

### 2ï¸âƒ£ **WebFlux + 2-Level Cache** (Phase 4)
```java
// Non-blocking I/O + Caffeine + Redis
```
**ì˜ˆìƒ íš¨ê³¼:**
- TPS: 4,940 â†’ **10,781** (+118%) ğŸš€
- P95: 360ms â†’ **<600ms** (Phase 4 ì‹¤ì¸¡)
- í‰ê· : 166ms â†’ **66ms** (-60%) ğŸš€

---

## ê²°ë¡ 

### âœ… Phase 3ì˜ ê°€ì¹˜

1. **ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì•„í‚¤í…ì²˜ ê²€ì¦**
   - Kafkaë¥¼ í†µí•œ ë¹„ë™ê¸° ì²˜ë¦¬ íš¨ê³¼ ì‹¤ì¦
   - Phase 2 ëŒ€ë¹„ 7.7% TPS í–¥ìƒ

2. **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì¤€ë¹„**
   - ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ êµ¬ì¶•
   - í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°

3. **ì‘ë‹µ ì‹œê°„ ê°œì„ **
   - P95 15% ë‹¨ì¶•
   - í‰ê·  7% ë‹¨ì¶•

### âŒ í•œê³„

- **10K TPS ëª©í‘œ ë¯¸ë‹¬** (49.4%)
- Tomcat Blocking ëª¨ë¸ì˜ ê·¼ë³¸ì  í•œê³„
- WebFlux ì „í™˜ í•„ìš”

### ğŸ’¡ êµí›ˆ

**"Kafka ë¹„ë™ê¸° ì²˜ë¦¬ëŠ” íš¨ê³¼ì ì´ì§€ë§Œ, Blocking I/Oì˜ ê·¼ë³¸ì  í•œê³„ëŠ” í•´ê²° ëª»í•œë‹¤."**

```
ê°œì„  ê²½ë¡œ:
Phase 1 (No Cache):            4,198 TPS
Phase 2 (Redis):               4,587 TPS (+9.3%)
Phase 3 (Redis + Kafka):       4,940 TPS (+7.7%) âœ…
Phase 4 (WebFlux + 2-Level):  10,781 TPS (+118%) ğŸš€
```

â†’ **Reactive ì•„í‚¤í…ì²˜ë¡œì˜ ì „í™˜ì´ í•„ìˆ˜!**

---

## í…ŒìŠ¤íŠ¸ ì¬í˜„

```bash
# 1. Phase 3 ë¸Œëœì¹˜ë¡œ ì´ë™
git checkout phase3

# 2. DB ë° Redis ì´ˆê¸°í™”
redis-cli FLUSHALL
mysql -uroot -p<password> bitly -e "TRUNCATE TABLE urls; TRUNCATE TABLE url_clicks;"

# 3. ì„œë²„ ì‹œì‘ (Kafka í¬í•¨)
cd backend
DB_USERNAME=root DB_PASSWORD=<password> ./gradlew bootRun --args='--spring.profiles.active=phase3'

# 4. 10K TPS í…ŒìŠ¤íŠ¸ ì‹¤í–‰
cd ..
k6 run backend/performance-tests/target-10k-test.js
```

---

## ì „ì²´ Phase ë¹„êµ (ìµœì¢…)

| Phase | í•µì‹¬ ê¸°ìˆ  | TPS | ëª©í‘œ ë‹¬ì„±ë¥  | íŠ¹ì§• |
|-------|----------|-----|------------|------|
| **Phase 1** | Tomcat | 4,198 | 42.0% | ê¸°ë³¸ êµ¬ì„± |
| **Phase 2** | Tomcat + Redis | 4,587 | 45.9% | ìºì‹± ë„ì… |
| **Phase 3** | Tomcat + Redis + Kafka | **4,940** | **49.4%** | ë¹„ë™ê¸° ì´ë²¤íŠ¸ |
| **Phase 4** | **WebFlux + Caffeine + Redis** | **10,781** | **107.8%** âœ… | **Reactive + 2-Level Cache** ğŸš€ |

**ê²°ë¡ : Phase 4ì˜ Reactive ì•„í‚¤í…ì²˜ê°€ ìœ ì¼í•œ í•´ë²•!**
