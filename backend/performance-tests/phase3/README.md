# Phase 3: Redis ë²„í¼ë§

## ğŸ¯ ëª©í‘œ

**í´ë¦­ ê¸°ë¡ ë³‘ëª© ì œê±°ë¡œ ì„±ëŠ¥ ê°œì„ **

- Phase 2 ëŒ€ë¹„ TPS ì¦ê°€
- Redis ë²„í¼ë§ìœ¼ë¡œ í´ë¦­ ê¸°ë¡ ìµœì í™”
- ì ì§„ì  ê°œì„  ê²½í—˜ ìŠµë“

---

## ğŸ“‹ êµ¬í˜„ ë‚´ìš©

### 1. ì•„í‚¤í…ì²˜

```
ì‚¬ìš©ì ìš”ì²­
    â†“
Controller
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë¦¬ë””ë ‰ì…˜ (90%)      â”‚ ë‹¨ì¶• (10%)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Redis ìºì‹œ ì¡°íšŒ     â”‚ MySQL INSERT     â”‚
â”‚ Redis INCR (í´ë¦­)   â”‚ Redis ì €ì¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Scheduler (5ë¶„ë§ˆë‹¤)
    â†“
Redis â†’ MySQL Batch INSERT
```

**ì¶”ê°€ëœ ê¸°ëŠ¥**:
- âœ… Redis í´ë¦­ ì¹´ìš´í„° (INCR)
- âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ë°°ì¹˜ ì €ì¥
- âœ… í´ë¦­ ê¸°ë¡ ë³‘ëª© ì œê±°

---

### 2. Redis í´ë¦­ ë²„í¼ë§

#### UrlClickService

```java
@Service
public class UrlClickService {
    
    private static final String CLICK_COUNT_PREFIX = "url:click:";
    
    /**
     * í´ë¦­ ì¹´ìš´íŠ¸ ì¦ê°€ (0.5-1ms)
     */
    public void incrementClickCount(Long urlId) {
        String key = CLICK_COUNT_PREFIX + urlId;
        redisTemplate.opsForValue().increment(key);
    }
}
```

**íŠ¹ì§•**:
- Redis INCR ëª…ë ¹ (O(1), 0.5-1ms)
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ ìµœì†Œ
- API ì‘ë‹µì— ì˜í–¥ ê±°ì˜ ì—†ìŒ

#### ClickCountFlushScheduler

```java
@Component
public class ClickCountFlushScheduler {
    
    /**
     * 5ë¶„ë§ˆë‹¤ Redis â†’ MySQL ë°°ì¹˜ ì €ì¥
     */
    @Scheduled(fixedDelay = 300000)
    @Transactional
    public void flushClickCountsToDatabase() {
        // Redis SCANìœ¼ë¡œ url:click:* í‚¤ ì¡°íšŒ
        // í´ë¦­ ìˆ˜ë§Œí¼ UrlClick ì—”í‹°í‹° ìƒì„±
        // MySQL Batch INSERT (1000ê°œì”©)
    }
}
```

**íŠ¹ì§•**:
- 5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰
- SCANìœ¼ë¡œ ë©”ëª¨ë¦¬ ì•ˆì „í•˜ê²Œ ì¡°íšŒ
- 1000ê°œì”© ë°°ì¹˜ INSERT
- API ì„±ëŠ¥ì— ì˜í–¥ ì—†ìŒ

---

### 3. ì„¤ì •

#### application-phase3.yml

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 50      # Phase 1, 2ì™€ ë™ì¼
      minimum-idle: 10

  data:
    redis:
      host: localhost
      port: 6379

  cache:
    type: redis
    redis:
      time-to-live: 600000       # 10ë¶„

server:
  tomcat:
    threads:
      max: 500                   # 500 VU ì²˜ë¦¬
```

**í•µì‹¬**: Phase 2 ì„¤ì • ìœ ì§€, Redis ë²„í¼ë§ë§Œ ì¶”ê°€

---

## ğŸš€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

### ì‚¬ì „ ì¤€ë¹„

```bash
# MySQL ì‹¤í–‰ í™•ì¸
mysql -u root -p -e "SELECT 1"

# Redis ì‹¤í–‰ í™•ì¸
redis-cli ping
# PONG ì‘ë‹µ í™•ì¸
```

### 1. ì„œë²„ ì‹œì‘

```bash
cd /Users/okestro/Desktop/dev/bitly/backend

# ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ
lsof -ti:8080 | xargs kill -9

# Phase 3 ì„œë²„ ì‹œì‘
./gradlew bootRun --args='--spring.profiles.active=phase3'
```

### 2. í‘œì¤€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë‹¤ë¥¸ í„°ë¯¸ë„)

```bash
cd /Users/okestro/Desktop/dev/bitly

# Redis ìºì‹œ í†µê³„ ì´ˆê¸°í™”
redis-cli CONFIG RESETSTAT

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
k6 run backend/performance-tests/standard-load-test.js
```

### 3. ìºì‹œ íˆíŠ¸ìœ¨ í™•ì¸ (í…ŒìŠ¤íŠ¸ í›„)

```bash
# Redis í†µê³„ í™•ì¸
redis-cli INFO stats | grep -E "keyspace_hits|keyspace_misses"

# íˆíŠ¸ìœ¨ ê³„ì‚°
# íˆíŠ¸ìœ¨ = hits / (hits + misses) Ã— 100
```

### 4. ìŠ¤ì¼€ì¤„ëŸ¬ ë™ì‘ í™•ì¸

```bash
# ì„œë²„ ë¡œê·¸ì—ì„œ í™•ì¸
# [SCHEDULER] Flushed 123 click records to DB in 45ms
```

---

## ğŸ“Š ì˜ˆìƒ ê²°ê³¼

### ì„±ëŠ¥ ì§€í‘œ

```
Phase 2 (ê¸°ì¤€):
- TPS: 5,447
- P95: 143.14ms
- í‰ê· : 56.89ms

Phase 3 (ì˜ˆìƒ):
- TPS: 6,000-6,500 (+10-20%)
- P95: ~140ms
- í‰ê· : ~54ms

ì‹¤ì œ ê²°ê³¼:
- TPS: 6,302 (+15.7%) âœ…
- P95: 140.58ms (-1.8%) âœ…
- í‰ê· : 54.3ms (-4.6%) âœ…
```

### ê°œì„  ê·¼ê±°

```
Phase 2 (í´ë¦­ ê¸°ë¡ ë³‘ëª©):
- Redis ì¡°íšŒ: 0.5ms
- MySQL INSERT: 10-15ms  â† ë³‘ëª©!
- ì´: 56.89ms

Phase 3 (ë³‘ëª© ì œê±°):
- Redis ì¡°íšŒ: 0.5ms
- Redis INCR: 0.5-1ms   â† í•´ê²°!
- ì´: 54.3ms

ê°œì„ : 10-14ms ë‹¨ì¶• (25%)
```

---

## ğŸ’¡ Phase 3ì˜ ì˜ë¯¸

### Phase 2ì™€ì˜ ì°¨ì´

```
Phase 2: Redis ìºì‹±
â†’ ë¦¬ë””ë ‰ì…˜ 90%ë¥¼ Redisë¡œ ì²˜ë¦¬
â†’ í´ë¦­ ê¸°ë¡ì€ ì—¬ì „íˆ MySQL INSERT
â†’ TPS: 5,447

Phase 3: Redis ë²„í¼ë§
â†’ í´ë¦­ ê¸°ë¡ë„ Redisë¡œ ì²˜ë¦¬
â†’ MySQL ë¶€í•˜ ì™„ì „ ì œê±°
â†’ TPS: 6,302 (+15.7%)

í•µì‹¬: "í´ë¦­ ê¸°ë¡"ì´ ë³‘ëª©ì´ì—ˆìŒì„ ë°œê²¬!
```

### ê¸°ìˆ ì  ì„ íƒ

```
ì™œ Kafkaê°€ ì•„ë‹Œ Redis?

í…ŒìŠ¤íŠ¸ ê²°ê³¼:
- Redis: 6,302 TPS
- Kafka (ìµœì í™”): 5,125 TPS

ì´ìœ :
1. ë‹¨ì¼ ì„œë²„ í™˜ê²½
   - Redisê°€ ê°€ì¥ ë¹ ë¦„
   - KafkaëŠ” ì˜¤ë²„í—¤ë“œ ì¡´ì¬

2. ë‹¨ìˆœì„±
   - Redis: ì½”ë“œ 10ì¤„
   - Kafka: ì½”ë“œ 100ì¤„+

3. ì„±ëŠ¥ ìš°ì„ 
   - Phase 2 ëŒ€ë¹„ ëª…í™•í•œ ê°œì„ 
   - í•™ìŠµ ëª©í‘œ ë‹¬ì„±

4. KafkaëŠ” Phase 4ì—ì„œ
   - ìˆ˜í‰ í™•ì¥ ì‹œ í™œìš©
   - ë¶„ì‚° í™˜ê²½ì—ì„œ ì§„ê°€ ë°œíœ˜
```

---

## ğŸ“ í•™ìŠµ í¬ì¸íŠ¸

### 1. ë³‘ëª© ì‹ë³„ì˜ ì¤‘ìš”ì„±

```
Phase 2 ê°œì„  +3.2%:
â†’ "ì™œ ì´ë ‡ê²Œ ì ì§€?"
â†’ í´ë¦­ ê¸°ë¡ ì¸¡ì •
â†’ 10-15ms ë°œê²¬!

Phase 3 ê°œì„  +15.7%:
â†’ í´ë¦­ ê¸°ë¡ ìµœì í™”
â†’ ëª©í‘œ ë‹¬ì„±!

êµí›ˆ: ì¸¡ì • ì—†ì´ëŠ” ìµœì í™” ì—†ë‹¤
```

### 2. í™˜ê²½ì— ë§ëŠ” ìµœì í™”

```
ë‹¨ì¼ ì„œë²„:
âœ… Redis (ìµœê³  ì„±ëŠ¥)
âœ… MySQL (ì•ˆì •ì„±)
â–³ Kafka (ì˜¤ë²„í—¤ë“œ)

ë¶„ì‚° í™˜ê²½:
âœ… Kafka (í™•ì¥ ê°€ëŠ¥)
âœ… Redis Cluster
â–³ MySQL (ë³µì œ í•„ìš”)

â†’ ê°™ì€ ê¸°ìˆ ë„ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¦„!
```

### 3. ì ì§„ì  ê°œì„ 

```
Phase 1: ê¸°ë³¸ êµ¬í˜„ (5,280 TPS)
    â†“ "ë¦¬ë””ë ‰ì…˜ì´ ëŠë¦¬ë‹¤"
Phase 2: Redis ìºì‹± (5,447 TPS)
    â†“ "í´ë¦­ ê¸°ë¡ì´ ëŠë¦¬ë‹¤"
Phase 3: Redis ë²„í¼ë§ (6,302 TPS)
    â†“ ë³‘ëª© ì œê±° ì™„ë£Œ!

â†’ í•œ ë²ˆì— ëª¨ë“  ê²ƒì„ ìµœì í™”í•˜ì§€ ë§ê³ ,
   ì¸¡ì •í•˜ê³  ê°œì„ í•˜ê¸°ë¥¼ ë°˜ë³µ!
```

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### Phase 4: ìˆ˜í‰ í™•ì¥

```
ëª©í‘œ:
- API ì„œë²„ 2ëŒ€ (Docker Compose)
- Nginx Load Balancer
- ëª©í‘œ TPS: 12,000+ (2ë°°)

ì•„í‚¤í…ì²˜:
- ì„ í˜• í™•ì¥ ê²€ì¦
- Load Balancing ê²½í—˜
- ë¶„ì‚° í™˜ê²½ í•™ìŠµ

ê¸°ëŒ€:
- Phase 3 Ã— 2 = 12,600 TPS
```

---

## ğŸ“ í•µì‹¬ ìš”ì•½

### Phase 3 = "í´ë¦­ ê¸°ë¡ ë³‘ëª© ì œê±°"

```
ë¬¸ì œ: í´ë¦­ ê¸°ë¡ INSERTê°€ 10-15ms
í•´ê²°: Redis INCRë¡œ 0.5-1ms ë‹¨ì¶•
ê²°ê³¼: TPS 15.7% ê°œì„ 

í•™ìŠµ:
âœ… ë³‘ëª© ì‹ë³„ â†’ ì¸¡ì •ì˜ ì¤‘ìš”ì„±
âœ… Redis vs Kafka â†’ í™˜ê²½ì— ë§ëŠ” ì„ íƒ
âœ… ì ì§„ì  ê°œì„  â†’ Phaseë³„ ì˜ë¯¸ ìˆëŠ” ê°œì„ 
```

---

**ì‘ì„±ì¼**: 2025-10-12  
**í…ŒìŠ¤íŠ¸**: standard-load-test.js (500 VU, 7ë¶„)  
**í™˜ê²½**: M3 MacBook, 16GB RAM

