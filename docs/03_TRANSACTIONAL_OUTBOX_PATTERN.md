## 1. 문제 배경

단축 URL 생성 시 DB 저장은 성공했으나 Kafka 장애로 이벤트 발행에 실패할 경우 다음과 같은 문제가 발생합니다.

1. **이벤트 발행 실패**: DB에는 저장되었으나 Kafka로 메시지가 전송되지 않음
2. **캐시 미적재**: Redirect Service가 이벤트를 수신하지 못해 L1, L2 캐시에 데이터가 저장되지 않음
3. **DB 부하 증가**: 사용자 요청 시 Cache Miss가 발생하여 모든 트래픽이 DB로 몰림

## 2. 해결 전략

### 2.1 CDC (Capture Data Change)
DB의 Transaction Log(Binlog)를 읽어 변경 사항을 감지하고 이벤트를 발행하는 방식입니다.
애플리케이션 코드와 이벤트 발행을 완벽히 분리할 수 있지만, Debezium, Kafka Connect 등 별도의 인프라 구축 및 운영 복잡도가 높고, 현재 프로젝트 규모 대비 오버엔지니어링이라 판단했다.

### 2.2 Transactional Outbox Pattern (채택)
DB 트랜잭션 내에서 단축 URL과 함께 이벤트 메시지를 `Outbox` 테이블에 저장하는 방식이다. 별도의 `OutboxEventRelay` 스케줄러가 `PENDING` 상태의 이벤트를 주기적으로 읽어 Kafka로 발행한다. 발행 실패 시 상태를 유지하거나 재시도하여 최소 1회 발행(At-Least-Once)을 보장한다.

## 3. 결과

| 지표 | 적용 전 (Dual Write) | 적용 후 (Outbox) | 개선 효과 |
| :--- | :--- | :--- | :--- |
| **데이터 일관성** | 불일치 발생 가능 | **최종적 일관성 보장** | **100% 신뢰성** |
| **트랜잭션 응답 시간** | Kafka Latency 포함 | **DB 저장 즉시 반환** | **Latency 감소** |
| **장애 격리** | Kafka 장애 시 서비스 불가 | **서비스 정상 동작** | **결합도 제거** |
