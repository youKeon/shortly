# 서비스 통신 과정 중 네트워크 에러 시 발생하는 문제

## 1. Kafka 이벤트 발행 실패 시 데이터 정합성 문제

### 문제 상황
1.  사용자가 URL 단축을 요청.
2.  단축 URL을 생성하고, URL 정보를 url 테이블에 저장.
3.  단축 URL 생성 정보를 담은 이벤트를 Kafka에 발행.
4.  `이때 Kafka 장애로 인해 이벤트 발행에 실패.`
5.  url 테이블에는 데이터가 있지만, 리다이렉트 서비스의 DB에는 데이터 누락.
6.  이후 사용자가 단축 URL로 리다이렉트를 시도하면, 리다이렉트 서비스는 URL을 찾지 못해 실패.

### 해결 방안

#### 1. Outbox Pattern
1. 이벤트 발행 내용을 저장할 `outbox_event` 테이블을 추가.
2. `URL 정보 DB 저장`과 `outbox_event 테이블에 이벤트 내용 저장`을 하나의 트랜잭션으로 묶어 원자성 보장.
3. 스케줄러로 `outbox_event` 테이블을 폴링하여, 발행되지 않은 이벤트를 Kafka로 발행.
4. 발행에 성공한 이벤트는 테이블에서 삭제하거나 '발행 완료' 상태로 업데이트.

#### 2. CDC (Change Data Capture)
1.  Debezium과 같은 CDC 커넥터를 사용하여 DB(MySQL)의 binlog를 스트리밍.
2.  `url` 테이블에 데이터가 삽입되는 변경 사항을 감지.
3.  감지된 변경 데이터를 기반으로 Kafka 이벤트 발행.

### 선택: Outbox Pattern

- **이유:**
  - URL 단축이 로직과 이벤트 발행은 하나의 작업 단위로 원자성이 보장되어야함.
  - Outbox Pattern은 트랜잭션을 통해 이 둘의 원자성을 보장하므로, 이벤트 유실로 인한 데이터 정합성 문제를 방지함.
  - CDC는 트랜잭션 외부에서 동작하므로 DB 커밋과 실제 이벤트 발행 과정에서 장애가 발생하면 정합성이 깨질 수 있음.
  - CDC 도입은 별도의 인프라 구성 및 운영 복잡성이 더 높다고 판단.


## 2. Fallback
